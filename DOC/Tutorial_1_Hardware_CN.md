## 硬件设计过程
EtherCAT从站芯片参考[https://www.ethercat.org/download/documents/ESC_Overview.pdf](https://www.ethercat.org/download/documents/ESC_Overview.pdf)。
主要分为三大类：
- 纯从站，需配上位机，如lan9252
- 嵌入内核，如xmc4800
- 软核+实时硬核，如amic110

设计之初需要考虑好不好购买和技术支持，毕竟不是大厂批量采购，技术支持全靠谷歌。这样筛选下来就剩：
- lan9252
- amic110
- xmc4800

9252+STM32的方案很多了，国内至少十几家在做，也有热心网友如[丁丁的个人网站](https://www.hexcode.cn/article/5e3ee9a835616641b2daef97)将整个流程清晰完整地展现出来。但我觉得门槛仍有些高。

amic110的资料实在太少太复杂，我连官方教程（基于TI CCS IDE）配置都没有通过。

XMC4800资料多，EVM板价格也比较适中，买了个测试了挺久。缺点也是有的，外挂phy太占用引脚了。

我的硬件设计是工作中自学的，断断续续做一些小电路板测试。xmc4300最纠结的就是PHY选择。硬件设计可能会有不少问题，恳请各位指正。

## 设计目标

xmc4800 relax板的phy是bcm5241，但它需要的外围器件较多，相关资料也少。参考了倍福的phy selection后，结合购买渠道决定用TI的DP83848，在立创、淘宝、贸泽、云汉上都能买到，价格不贵，外围电路也更简单。

由于4层板打样价格较高，xmc4300又是lqfp100封装，所以初期目标就是2层PCB，打样了一套后跑起来了（当时用的是KSZ8081），但在测试长距离通讯时有严重丢帧，重新layout也没有效果。

由于工作较忙搁置了一段时间，之后再用的话发现做出来的核心板没有意义，24v供电处理占用了1/3的PCB空间。偶然在一个设备上看到自制的fb1111核心板，便想尝试做个尺寸兼容的板子试试。

综上，目标是以下几点：
- xmc4300＋DP83848
- 双层PCB，单面贴片，元器件尽可能少
- 尺寸和fb1111一致，引脚尽量兼容（spi从模式，这样原先使用fb1111的只需要修改程序即可兼容）
- 尽量使用通用、易采购的元器件，尽量使用0603封装。

## 设计过程

pinout参考了官方的xmc4300 ethercat模板，我觉得官方选择的引脚应该是可靠的，所以直接照搬。

DP83848是在Google搜到的原理图，结合evm板组合一下，剩下就是简单连线了。

网口电容用了2个2kv耐压电容，并与PE相连，这部分参考[原始原理图](https://www.infineon.com/dgdl/Infineon-Board_User_Manual_XMC4700_XMC4800_Relax_Kit_Series-UM-v01_02-EN.pdf?fileId=5546d46250cc1fdf01513f8e052d07fc)。

由于板子空间有限，放不下tvs、电感、电解电容了，所以供电部分尽量简化，防护主要做在底板上。

HR913550A和HR911105A是Pin2Pin兼容，都可以使用，并且脚距为2.54，可以直接焊排针接到扩展底板。

1117的发热较大，加了散热焊盘但仍然偏热，不过使用正常。

此外，实际测试时发现外围设备对电源的影响还是蛮大的，建议单独给核心板一个5v供电。dcdc水也很深，我用的是tps5430并严格按照官方layout，使用良好。外围设备有用5v的可以再来一个，3.3v的单独挂一个1117也ok。我理解的电气隔离并不需要隔离dcdc，让它们互不干扰即可。

## 温度问题

XMC4300F100F256标称最高运行温度是85度，K256是125度。实际使用时相对于LAN9252/ET1100，可以明显感觉XMC系列发热更高。

通过[XMC_SCU_GetTemperatureMeasurement()](https://www.infineonforums.com/threads/5861-XMC4300-Onchip-Temperature)获取片上核心温度传感器，无散热片自然散热，室温25摄氏度，空运行半小时后，在XMC48RELAX板上读取到**48**摄氏度，在本项目核心板上读取到**54**摄氏度，考虑到芯片尺寸和LAYOUT差异，应在正常范围（约700mW，~Tamp+25℃）。下一版需加大底层铜皮连接。(功率比同主频STM32或XMC4500高两倍左右，应该是塞了EtherCAT核心的关系）

XMC48RELAX的5V电流约为290ma（含板载jlink），本项目核心板5V电流约为210ma，5转3.3的1117自然散热上限在400ma左右，不建议对核心板上的3.3v做其它用处。此外定制底板时，如空间足够，建议将1117整合在底板内并加大散热焊盘以改善散热表现。




